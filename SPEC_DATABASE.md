# üçÉ MongoDB Persistence Specification (SPEC_DATABASE.md)

This document specifies the persistence layer for maintaining conversation history and user session state.

## 1. Overview
The bot uses MongoDB for asynchronous persistence of chat histories. This ensures that the agentic system has context for multi-turn legal consultations and allows for horizontal scaling of the bot application.

## 2. Infrastructure
- **Driver**: `motor` (Asynchronous Python driver for MongoDB).
- **Client**: `AsyncIOMotorClient` with connection pooling.
- **Connection Logic**: Managed by `src/mongo.py:MongoDBManager` with automatic re-initialization if the event loop changes.

## 3. Data Schema

### 3.1 Database & Collection
- **Database Name**: Default is `SugarSquare_bot` (controlled by `BOT_NAME` in `.env`).
- **Collection Name**: `chat_history`.

### 3.2 Document Structure
Each document represents a single message in the conversation.
```json
{
  "_id": "ObjectId",
  "session_id": "String (Telegram User ID)",
  "history": "JSON String (Serialized LangChain Message)"
}
```

#### Serialized Message Format
The `history` field contains a serialized `BaseMessage` dictionary:
- `human`: Text from the user.
- `ai`: Text generated by the bot, including `confidence_score` and `timestamp` in `additional_kwargs`.

## 4. Operational Logic

### 4.1 Indexing
- An index is created on the `session_id` field to ensure fast retrieval of conversation threads.

### 4.2 Retrieval & Sorting
- Messages are retrieved filtered by `session_id` and sorted by `_id` (ascending) to maintain chronological order.
- The system typically loads the last 10-15 messages for active reasoning context.

### 4.3 History Management
- **Persistence**: Messages are saved immediately after generation in the `agentic_text_chat_handler`.
- **Clearing**: Users can clear their session via the `/clear_memory` command, which triggers a `delete_many` operation on the `session_id`.

## 5. Persistence Defaults
- **Default Host**: `mongodb://localhost`
- **Default Port**: `27017`
- **Connection Timeout**: Managed by standard Motor defaults, usually wrapped in LLM orchestration timeouts.
